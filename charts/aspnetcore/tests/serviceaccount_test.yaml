suite: serviceaccount tests
templates:
  - serviceaccount.yaml
tests:
  - it: should not create serviceaccount when serviceAccount.create is false
    set:
      serviceAccount:
        create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create serviceaccount when serviceAccount.create is true
    set:
      serviceAccount:
        create: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount

  - it: should add azure workload identity labels when enabled
    set:
      serviceAccount:
        create: true
      azureWorkloadIdentity:
        enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.labels["azure.workload.identity/use"]
          value: "true"

  - it: should add azure workload identity client-id annotation when provided
    set:
      serviceAccount:
        create: true
      azureWorkloadIdentity:
        enabled: true
        clientId: "12345678-1234-1234-1234-123456789012"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: "12345678-1234-1234-1234-123456789012"

  - it: should not add azure workload identity client-id annotation when not provided
    set:
      serviceAccount:
        create: true
      azureWorkloadIdentity:
        enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isNull:
          path: metadata.annotations["azure.workload.identity/client-id"]

  - it: should apply commonLabels and commonAnnotations
    set:
      serviceAccount:
        create: true
      commonLabels:
        environment: "production"
      commonAnnotations:
        owner: "team-a"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.labels.environment
          value: "production"
      - equal:
          path: metadata.annotations.owner
          value: "team-a"
