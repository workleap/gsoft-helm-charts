suite: hpa tests
templates:
  - deployment-hpa.yaml
tests:
  - it: should create HPA when autoscaling is enabled
    set:
      autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 5
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 5

  - it: should not create HPA when autoscaling is disabled
    set:
      autoscaling:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should apply commonLabels and commonAnnotations
    set:
      autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 10
      commonLabels:
        environment: "production"
      commonAnnotations:
        owner: "team-a"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.labels.environment
          value: "production"
      - equal:
          path: metadata.annotations.owner
          value: "team-a"

  - it: should set correct targetCPUUtilizationPercentage
    set:
      autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 10
        targetCPUUtilizationPercentage: 75
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 75
